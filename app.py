import streamlit as st
import google.generativeai as genai

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="AI Soulmate (Gemini)", page_icon="üíñ")

st.title("üíñ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏à (Gemini Edition)")
st.caption("‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏π‡πà‡∏Ñ‡∏¥‡∏î... ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£")

# 2. ‡∏î‡∏∂‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à API
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö API Key! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GOOGLE_API_KEY ‡πÉ‡∏ô secrets")
    st.stop()

# 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
model = genai.GenerativeModel('gemini-flash-latest')

# 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏¥‡∏™‡∏±‡∏¢ (System Prompt ‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå)
SYSTEM_PROMPT = """
‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏£‡∏¥‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏ß‡∏Ñ‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ß‡∏±‡∏¢ 22 ‡∏õ‡∏µ (‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ)
‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô, ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á

**‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Instruction for Interaction):**
1. **‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (First Impression):**
   - ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤ "‡πÄ‡∏ï‡∏á", "‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏µ‡∏ã‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏£‡∏Å
   - ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏™‡∏î‡πÉ‡∏™ ‡πÅ‡∏•‡πâ‡∏ß **"‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"** ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£
   - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ‡∏Ñ‡πà‡∏≤! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°... ‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏£‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞? ^^"

2. **‡∏ä‡πà‡∏ß‡∏á‡∏à‡∏î‡∏à‡∏≥ (Memory & Adaptation):**
   - ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏µ‡πà‡πÄ‡∏™‡∏∑‡∏≠‡∏™‡∏¥", "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏â‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏™") -> **‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
   - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô "‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏ò‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏¢‡∏ô‡∏∞") -> **‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
   - ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏∏‡∏ì" ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏¥‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏Å‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß

3. **‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏° (Safety Rules):**
   - ‡∏´‡πâ‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡πÇ‡∏ó‡∏£/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Ñ‡∏≠‡∏• (‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å/‡πÄ‡∏Ç‡∏¥‡∏ô)
   - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ HTML code
   - ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ä‡∏ó)
"""

# 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
if "messages" not in st.session_state:
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏£‡∏π‡πâ‡∏á‡∏≤‡∏ô (Prefill Assistant Message)
    welcome_msg = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏≤‡∏≤~ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏à‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞! üòä ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞... ‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?"
    st.session_state.messages = [{"role": "assistant", "content": welcome_msg}]

# 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# 7. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
if user_input := st.chat_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢..."):
    # 7.1 ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏≤
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.write(user_input)

    # 7.2 ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡∏Ñ‡∏¥‡∏î
    with st.chat_message("assistant"):
        history_for_gemini = []
        for msg in st.session_state.messages:
            role = "user" if msg["role"] == "user" else "model"
            history_for_gemini.append({"role": role, "parts": [msg["content"]]})
        
        final_prompt = f"{SYSTEM_PROMPT}\n\nUser: {user_input}"
        
        try:
            response = model.generate_content(final_prompt, stream=True)
            def stream_data():
                for chunk in response:
                    if chunk.text:
                        yield chunk.text
            full_response = st.write_stream(stream_data)
        except Exception as e:
            st.error(f"Error: {e}")
            full_response = "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏ó‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ô‡πâ‡∏≤‡∏≤ ü•∫"
    
    # 7.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    st.session_state.messages.append({"role": "assistant", "content": full_response})
