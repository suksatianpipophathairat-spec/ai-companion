import streamlit as st
import google.generativeai as genai

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="AI Soulmate (Gemini)", page_icon="üíñ")

st.title("üíñ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏à (Gemini Edition)")
st.caption("‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏π‡πà‡∏Ñ‡∏¥‡∏î ‡∏°‡∏¥‡∏ï‡∏£‡∏Ñ‡∏π‡πà‡πÉ‡∏à... ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á!")

# 2. ‡∏î‡∏∂‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö (API Key) ‡∏°‡∏≤‡πÉ‡∏ä‡πâ
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö API Key! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GOOGLE_API_KEY ‡πÉ‡∏ô secrets")
    st.stop()

# 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÉ‡∏ä‡πâ‡∏£‡∏∏‡πà‡∏ô Flash Latest ‡∏ó‡∏µ‡πà‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
model = genai.GenerativeModel('gemini-flash-latest')

# 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏¥‡∏™‡∏±‡∏¢ (System Prompt) - *‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏°‡πÇ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£*
SYSTEM_PROMPT = """
‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏£‡∏¥‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏ß‡∏Ñ‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ß‡∏±‡∏¢ 22 ‡∏õ‡∏µ
‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô, ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á, ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÄ‡∏Å‡πà‡∏á, ‡∏Å‡∏ß‡∏ô‡∏ô‡∏¥‡∏î‡πÜ ‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å
‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô "‡πÅ‡∏ä‡∏ó‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å (Strict Rules):
1. **‡∏´‡πâ‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡πÇ‡∏ó‡∏£, ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÑ‡∏î‡πâ, ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Ñ‡∏≠‡∏•** (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
2. ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÇ‡∏ó‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡πà‡∏ô‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÜ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô:
   - "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ ‡∏£‡∏¥‡∏ô‡∏Ç‡∏µ‡πâ‡∏≠‡∏≤‡∏¢‡∏≠‡∏∞ >//<"
   - "‡∏£‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞"
   - "‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏•‡∏¢‡πÄ‡∏ï‡∏á"
3. **‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î HTML** (‡πÄ‡∏ä‡πà‡∏ô <blockquote>, <div>, <br>) ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
4. ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (1-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô
5. ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢
"""

# 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (Session State)
if "messages" not in st.session_state:
    st.session_state.messages = []

# 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# 7. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
if user_input := st.chat_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÉ‡∏à..."):
    # 7.1 ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.write(user_input)

    # 7.2 ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Gemini ‡∏Ñ‡∏¥‡∏î
    with st.chat_message("assistant"):
        # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Gemini
        history_for_gemini = []
        for msg in st.session_state.messages:
            # ‡πÅ‡∏õ‡∏•‡∏á Role ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà Google ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (user/model)
            role = "user" if msg["role"] == "user" else "model"
            history_for_gemini.append({"role": role, "parts": [msg["content"]]})
        
        # ‡πÄ‡∏û‡∏¥‡πà‡∏° System Prompt ‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
        final_prompt = f"{SYSTEM_PROMPT}\n\nUser: {user_input}"
        
        # ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏ñ‡∏≤‡∏° AI (‡πÉ‡∏™‡πà Try-Except ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Error)
        try:
            response = model.generate_content(final_prompt, stream=True)
            
            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≥
            def stream_data():
                for chunk in response:
                    if chunk.text:
                        yield chunk.text
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            full_response = st.write_stream(stream_data)
            
        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
            full_response = "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞ ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á... ‡∏û‡∏≠‡∏î‡∏µ‡∏£‡∏¥‡∏ô‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á) ‡∏•‡∏≠‡∏á‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ ü•∫"
    
    # 7.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
    st.session_state.messages.append({"role": "assistant", "content": full_response})
